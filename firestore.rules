rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Default deny all access
    match /{document=**} {
      allow read, write: if false;
    }
    
    // Admin collection - only authenticated admins can access
    match /admins/{adminId} {
      // Only allow read if the user is authenticated and is the admin being accessed
      allow read: if request.auth != null && (request.auth.uid == adminId || 
                  exists(/databases/$(database)/documents/admins/$(request.auth.uid)));
      // Only allow write if the user is an existing admin
      allow write: if request.auth != null && 
                   exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // Shops collection - admins can read/write all, users can only access their own data
    match /shops/{shopId} {
      // Admins can read all shops
      allow read: if request.auth != null && 
                  (exists(/databases/$(database)/documents/admins/$(request.auth.uid)) || 
                   request.auth.uid == shopId);
      // Users can only read their own shop data
      allow read: if request.auth != null && request.auth.uid == shopId;
      // Only admins can create or update shop status
      allow create, update: if request.auth != null && 
                            (exists(/databases/$(database)/documents/admins/$(request.auth.uid)) || 
                             request.auth.uid == shopId);
      // Users can only update their own shop data and cannot change status
      allow update: if request.auth != null && 
                    request.auth.uid == shopId && 
                    !('status' in request.resource.data) || 
                    request.resource.data.status == resource.data.status;
    }
    
    // Orders collection - admins can read/write all, users can only access their own orders
    match /orders/{orderId} {
      // Admins can read all orders
      allow read: if request.auth != null && 
                  exists(/databases/$(database)/documents/admins/$(request.auth.uid));
      // Users can only read orders associated with their shop
      allow read: if request.auth != null && 
                  resource.data.shopId == request.auth.uid;
      // Only admins can create or update order status
      allow create, update: if request.auth != null && 
                            exists(/databases/$(database)/documents/admins/$(request.auth.uid));
      // Users can create orders for their own shop
      allow create: if request.auth != null && 
                    request.resource.data.shopId == request.auth.uid;
    }
    
    // Staff collection - shop owners can manage staff for their shop
    match /staff/{staffId} {
      // Shop owners can read/write staff data for their shop
      allow read, write: if request.auth != null && 
                         (exists(/databases/$(database)/documents/admins/$(request.auth.uid)) ||
                          resource.data.shopId == request.auth.uid);
      // Staff can read their own data
      allow read: if request.auth != null && request.auth.uid == staffId;
    }
    
    // Receipts collection - simplified for staff
    match /receipts/{receiptId} {
      allow read: if request.auth != null && 
                  (exists(/databases/$(database)/documents/admins/$(request.auth.uid)) ||
                   resource.data.shopId == request.auth.uid ||
                   exists(/databases/$(database)/documents/staff/$(request.auth.uid)));
      allow write: if request.auth != null && 
                   (exists(/databases/$(database)/documents/admins/$(request.auth.uid)) ||
                    resource.data.shopId == request.auth.uid);
    }
    
    // Employees collection
    match /employees/{employeeId} {
      allow read: if request.auth != null && 
                  (exists(/databases/$(database)/documents/admins/$(request.auth.uid)) ||
                   resource.data.shopId == request.auth.uid ||
                   exists(/databases/$(database)/documents/staff/$(request.auth.uid)));
      allow write: if request.auth != null && 
                   (exists(/databases/$(database)/documents/admins/$(request.auth.uid)) ||
                    resource.data.shopId == request.auth.uid);
    }
    
    // Attendance collection
    match /attendance/{attendanceId} {
      allow read, write: if request.auth != null && 
                         (exists(/databases/$(database)/documents/admins/$(request.auth.uid)) ||
                          resource.data.shopId == request.auth.uid ||
                          exists(/databases/$(database)/documents/staff/$(request.auth.uid)));
    }
    
    // Stock collection
    match /stock/{stockId} {
      allow read: if request.auth != null && 
                  (exists(/databases/$(database)/documents/admins/$(request.auth.uid)) ||
                   resource.data.shopId == request.auth.uid ||
                   exists(/databases/$(database)/documents/staff/$(request.auth.uid)));
      allow write: if request.auth != null && 
                   (exists(/databases/$(database)/documents/admins/$(request.auth.uid)) ||
                    resource.data.shopId == request.auth.uid);
    }
    
    // Salaries collection
    match /salaries/{salaryId} {
      allow read, write: if request.auth != null && 
                         (exists(/databases/$(database)/documents/admins/$(request.auth.uid)) ||
                          resource.data.shopId == request.auth.uid ||
                          exists(/databases/$(database)/documents/staff/$(request.auth.uid)));
    }
    
    // Expenses collection
    match /expenses/{expenseId} {
      allow read, write: if request.auth != null && 
                         (exists(/databases/$(database)/documents/admins/$(request.auth.uid)) ||
                          resource.data.shopId == request.auth.uid ||
                          exists(/databases/$(database)/documents/staff/$(request.auth.uid)));
    }
  }
}